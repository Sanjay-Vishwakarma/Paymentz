<%@ page import="com.directi.pg.Functions,com.directi.pg.Logger,com.directi.pg.core.GatewayAccount,com.directi.pg.core.GatewayAccountService,
                com.directi.pg.core.GatewayType,com.directi.pg.core.GatewayTypeService,org.owasp.esapi.ESAPI" %>
<%@ include file="index.jsp" %>
<%@ page import="org.owasp.esapi.errors.ValidationException" %>
<%@ page import="java.util.*" %>
<%@ page language="java" contentType="text/html; charset=utf-8" pageEncoding="utf-8"%>
<%!
    private static Logger log=new Logger("transactions.jsp");
%>
<script src="/icici/css/jquery-1.12.4.min.js"></script>
<script src="/icici/css/jquery-ui.min.js"></script>
<script src="/icici/javascript/gateway-account-member-terminalid1.js"></script>
<script src="/icici/javascript/cardtype-issuing-bank.js"></script>
<%
    HashMap<String, String> statusFlagHash = new LinkedHashMap();
    HashMap<String, String> statusHash = new LinkedHashMap();

    statusFlagHash.put("isChargeback", "Chargeback");
    statusFlagHash.put("isFraud", "Fraud");
    statusFlagHash.put("isRefund", "Refund");
    statusFlagHash.put("isRollingReserveKept", "RollingReserveKept");
    statusFlagHash.put("isRollingReserveReleased", "RollingReserveReleased");
    statusFlagHash.put("isSettled", "Settled");
    statusFlagHash.put("isSuccessful", "Successful");

    statusHash.put("authfailed", "Auth Failed");
    statusHash.put("authstarted", "Auth Started");
    statusHash.put("authstarted_3D", "Auth Started 3D");
    statusHash.put("authsuccessful", "Auth Successful");
    statusHash.put("authcancelled", "Authorisation Cancelled");
    statusHash.put("begun", "Begun Processing");
    statusHash.put("cancelstarted", "Cancel Initiated");
    statusHash.put("cancelled", "Cancelled Transaction");
    statusHash.put("capturefailed", "Capture Failed");
    statusHash.put("capturestarted", "Capture Started");
    statusHash.put("capturesuccess", "Capture Successful");
    statusHash.put("chargeback", "Chargeback");
    statusHash.put("partialrefund", "Partial Refund");
    statusHash.put("payoutfailed", "Payout Failed");
    statusHash.put("payoutstarted", "Payout Started");
    statusHash.put("payoutsuccessful", "Payout Successful");
    statusHash.put("podsent", "POD Sent ");
    statusHash.put("proofrequired", "Proof Required");
    statusHash.put("markedforreversal", "Reversal Request Sent");
    statusHash.put("reversed", "Reversed");
    statusHash.put("settled", "Settled");
    statusHash.put("failed", "Validation Failed");
    statusHash.put("payoutcancelstarted", "Payout Cancel Started");
    statusHash.put("payoutcancelsuccessful", "Payout Cancel Successful");
    statusHash.put("payoutcancelfailed", "Payout Cancel Failed");

    String gateway = Functions.checkStringNull(request.getParameter("gateway"));
    String accountid = request.getParameter("accountid")==null?"":request.getParameter("accountid");
    String memberid = request.getParameter("toid")==null?"":request.getParameter("toid");
    String pgtypeid = request.getParameter("pgtypeid")==null?"":request.getParameter("pgtypeid");
    String desc = Functions.checkStringNull(request.getParameter("desc"));
    String amt = Functions.checkStringNull(request.getParameter("amount"));
    String emailaddr = Functions.checkStringNull(request.getParameter("emailaddr"));
    String orderdesc = Functions.checkStringNull(request.getParameter("orderdesc"));
    String name = Functions.checkStringNull(request.getParameter("name"));
    String trackingid = Functions.checkStringNull(request.getParameter("STrackingid"));
    String toid = Functions.checkStringNull(request.getParameter("toid"))==null?"":request.getParameter("toid");
    String refundamount = Functions.checkStringNull(request.getParameter("refundamount"));
    String remark = Functions.checkStringNull(request.getParameter("remark"));
    String cardtype = Functions.checkStringNull(request.getParameter("cardtype"));
    String issuing_bank = Functions.checkStringNull(request.getParameter("issuing_bank"));
    String paymentid = Functions.checkStringNull(request.getParameter("paymentid"))==null?"":request.getParameter("paymentid");
    String dateType = Functions.checkStringNull(request.getParameter("datetype"));
    String firstfourofccnum = Functions.checkStringNull(request.getParameter("firstfourofccnum"));
    String lastfourofccnum = Functions.checkStringNull(request.getParameter("lastfourofccnum"));
    String startTime = Functions.checkStringNull(request.getParameter("starttime"));
    String endTime = Functions.checkStringNull(request.getParameter("endtime"));
    String perfectmatch = Functions.checkStringNull(request.getParameter("perfectmatch"));
    String flaghash = Functions.checkStringNull(request.getParameter("statusflag"));
    String status = Functions.checkStringNull(request.getParameter("status"));
    boolean archive = Boolean.valueOf(request.getParameter("archive")).booleanValue();

    String str = "";
    String selectedArchived = "", selectedCurrent = "";
    String archivalString = "Archived";
    String currentString = "Current";

    if (gateway == null) gateway = "";
    if (desc == null) desc = "";
    if (amt == null) amt = "";
    if (emailaddr == null) emailaddr = "";
    if (orderdesc == null) orderdesc = "";
    if (name == null) name = "";
    if (trackingid == null) trackingid = "";
    if (toid == null) toid = "";
    if (refundamount == null) refundamount = "";
    if (remark == null) remark = "";
    if (cardtype == null) cardtype = "";
    if (issuing_bank == null) issuing_bank = "";
    if (dateType == null) dateType = "";
    if (firstfourofccnum == null)firstfourofccnum = "";
    if (lastfourofccnum == null)lastfourofccnum = "";
    if (startTime == null) startTime = "00:00:00";
    if (endTime == null) endTime = "23:59:59";
    if (flaghash == null)
    {
        flaghash = "";
    }
    if (status == null)
    {
        status = "";
    }

    if (archive)
    {
        selectedCurrent = "";
    }
    else
    {
        selectedCurrent = "selected";
    }

    String fdate=null;
    String tdate=null;
    String fmonth=null;
    String tmonth=null;
    String fyear=null;
    String tyear=null;



    try
    {
        fdate = ESAPI.validator().getValidInput("fdate",request.getParameter("fdate"),"Days",2,true);
        tdate = ESAPI.validator().getValidInput("tdate",request.getParameter("tdate"),"Days",2,true);
        fmonth = ESAPI.validator().getValidInput("fmonth",request.getParameter("fmonth"),"Months",2,true);
        tmonth =  ESAPI.validator().getValidInput("tmonth",request.getParameter("tmonth"),"Months",2,true);
        fyear = ESAPI.validator().getValidInput("fyear",request.getParameter("fyear"),"Years",4,true);
        tyear = ESAPI.validator().getValidInput("tyear",request.getParameter("tyear"),"Years",4,true);
    }
    catch (ValidationException e)
    {
        log.error("Date Format Exception while select");
    }

    Calendar rightNow = Calendar.getInstance();
    String currentyear = "" + rightNow.get(Calendar.YEAR);
    if (fdate == null) fdate = "" + 1;
    if (tdate == null) tdate = "" + rightNow.get(Calendar.DATE);
    if (fmonth == null) fmonth = "" + rightNow.get(Calendar.MONTH);
    if (tmonth == null) tmonth = "" + rightNow.get(Calendar.MONTH);
    if (fyear == null) fyear = "" + rightNow.get(Calendar.YEAR);
    if (tyear == null) tyear = "" + rightNow.get(Calendar.YEAR);

    System.out.println("fmonth----->"+fmonth);
    System.out.println("tmonth----->"+tmonth);
    if (fdate != null) str = str + "fdate=" + fdate;
    if (tdate != null) str = str + "&tdate=" + tdate;
    if (fmonth != null) str = str + "&fmonth=" + fmonth;
    if (tmonth != null) str = str + "&tmonth=" + tmonth;
    if (fyear != null) str = str + "&fyear=" + fyear;
    if (tyear != null) str = str + "&tyear=" + tyear;
    if (startTime != null) str = str + "&starttime=" + startTime;
    if (endTime != null) str = str + "&endtime=" + endTime;
    if (desc != null) str = str + "&desc=" + desc;
    if (amt != null) str = str + "&amount=" + amt;
    if (emailaddr != null) str = str + "&emailaddr=" + emailaddr;
    if (name != null) str = str + "&name=" + name;
    if (trackingid != null) str = str + "&STrackingid=" + trackingid;
    if (orderdesc != null) str = str + "&orderdesc=" + orderdesc;
    if (toid != null) str = str + "&toid=" + toid;
    if (status != null) str = str + "&status=" + status;
    if (firstfourofccnum != null) str = str + "&firstfourofccnum=" + firstfourofccnum;
    if (lastfourofccnum != null) str = str + "&lastfourofccnum=" + lastfourofccnum;
    if (gateway !=null) str = str + "&gateway=" + gateway;
    if (remark !=null) str = str + "&remark=" + remark;
    if (cardtype !=null) str = str + "&cardtype=" + cardtype;
    if (issuing_bank !=null) str = str + "&issuing_bank=" + issuing_bank;
    if (flaghash !=null) str = str + "&statusflag=" + flaghash;
    if (pgtypeid !=null) str = str + "&pgtypeid=" + pgtypeid;
    if (accountid !=null) str = str + "&accountid=" + accountid;
    if (dateType != null) str = str + "&datetype=" + dateType;

    str = str + "&archive=" + archive;

    int pageno = Functions.convertStringtoInt(ESAPI.encoder().encodeForHTML(request.getParameter("SPageno")), 1);
    int pagerecords = Functions.convertStringtoInt(ESAPI.encoder().encodeForHTML(request.getParameter("SRecords")), 30);

    TreeMap<String,GatewayType> gatewayTypeTreeMap = GatewayTypeService.getAllGatewayTypesMap();
    TreeMap<Integer, GatewayAccount> accountDetails = GatewayAccountService.getAccountDetails();

%>
<html>
<head>
    <META HTTP-EQUIV="Pragma" CONTENT="no-cache">
    <title>Paymentz | Transactions List</title>
    <script language="javascript">
        function isint(form)
        {
            if (isNaN(form.numrows.value))
                return false;
            else
                return true;
        }
        function validateccnum()
        {

            var firstfourofccnum = document.form.firstfourofccnum.value;
            var lastfourofccnum= document.form.lastfourofccnum.value;
            if(firstfourofccnum.length==0 && lastfourofccnum.length==0 )
                return true;
            if(firstfourofccnum.length<4)
            {
                alert("Enter first four of ccnum");
                return false;
            }

            if( lastfourofccnum.length<4)
            {
                alert("Enter last four of ccnum");
                return false;
            }

        }

        function getExcelFile()
        {
            if(document.getElementById("containrecord"))
            {
                document.exportform.submit();
            }
        }
    </script>
    <script type="text/javascript" language="JavaScript" src="/icici/javascript/gateway-account-member.js"></script>
</head>
<body>
<%
    ctoken = ((User)session.getAttribute("ESAPIUserSessionKey")).getCSRFToken();
    if (com.directi.pg.Admin.isLoggedIn(session))
    {
        try
        {
%>
<form name="form" method="post" action="/icici/servlet/TransactionDetails?ctoken=<%=ctoken%>" onsubmit="return validateccnum()">
    <input type="hidden" value="<%=ctoken%>" name="ctoken">
    <div class="row" >
        <div class="col-lg-12" style="position:static;">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <p><%=archive ? archivalString : currentString%> Transactions Details</p>
                </div>
                <br>
                <table  align="center" width="95%" cellpadding="2" cellspacing="2" style="margin-left:2.5%;margin-right: 2.5% ">
                    <input type="hidden" value="<%=ctoken%>" name="ctoken" id="ctoken">
                    <tr>
                        <td>
                            <table border="0" cellpadding="5" cellspacing="0" width="100%"  align="center">
                                <tr><td colspan="12">&nbsp;</td></tr>
                                <tr>
                                    <td width="4%" class="textb">&nbsp;</td>
                                    <td width="8%" class="textb" >From</td>
                                    <td width="3%" class="textb"></td>
                                    <td width="7%" class="textb">
                                        <select size="1" name="fdate" value="" >
                                            <%
                                                if (fdate != null)
                                                    out.println(Functions.dayoptions(1, 31, fdate));
                                                else
                                                    out.println(Functions.printoptions(1, 31));
                                            %>
                                        </select>
                                        <select size="1" name="fmonth"  value="" >
                                            <%
                                                if (fmonth != null)
                                                    out.println(Functions.newmonthoptions(1, 12, fmonth));
                                                else
                                                    out.println(Functions.printoptions(1, 12));
                                            %>
                                        </select>
                                        <select size="1" name="fyear" value="" >
                                            <%
                                                if (fyear != null)
                                                    out.println(Functions.yearoptions(2005, Integer.parseInt(currentyear), fyear));
                                                else
                                                    out.println(Functions.printoptions(2005, 2020));
                                            %>
                                        </select>
                                    </td>
                                    <td width="10%" class="textb">
                                        <input type="text" size="6" placeholder="HH:MM:SS" name="starttime" maxlength="8" value="<%=startTime%>"/>
                                    </td>
                                    <td width="5%" class="textb">To</td>
                                    <td width="3%" class="textb"></td>
                                    <td width="7%" class="textb">
                                        <select size="1" name="tdate" >
                                            <%
                                                if (tdate != null)
                                                    out.println(Functions.dayoptions(1, 31, tdate));
                                                else
                                                    out.println(Functions.printoptions(1, 31));
                                            %>
                                        </select>

                                        <select size="1" name="tmonth" >
                                            <%
                                                if (tmonth != null)
                                                    out.println(Functions.newmonthoptions(1, 12, tmonth));
                                                else
                                                    out.println(Functions.printoptions(1, 12));
                                            %>
                                        </select>

                                        <select size="1" name="tyear" >
                                            <%
                                                if (tyear != null)
                                                    out.println(Functions.yearoptions(2005, Integer.parseInt(currentyear), tyear));
                                                else
                                                    out.println(Functions.printoptions(2005, 2020));
                                            %>
                                        </select>
                                    </td>
                                    <td width="10%" class="textb">
                                        <input type="text" size="6" placeholder="HH:MM:SS" name="endtime" maxlength="8" value="<%=endTime%>"/>
                                    </td>
                                    <td width="4%" class="textb" >Status</td>
                                    <td width="3%" class="textb"></td>
                                    <td width="10%" class="textb">
                                        <select size="1" name="status" class="txtbox">
                                            <option value="">All</option>
                                            <%
                                                Set statusSet = statusHash.keySet();
                                                Iterator iterator=statusSet.iterator();
                                                String selected = "";
                                                String key = "";
                                                String value = "";

                                                while (iterator.hasNext())
                                                {
                                                    key = (String)iterator.next();
                                                    value = (String) statusHash.get(key);

                                                    if (key.equals(status))
                                                        selected = "selected";
                                                    else
                                                        selected = "";
                                            %>
                                            <option value="<%=ESAPI.encoder().encodeForHTMLAttribute(key)%>" <%=selected%>><%=ESAPI.encoder().encodeForHTML(value)%></option>
                                            <%
                                                }
                                            %>
                                        </select>
                                    </td>

                                </tr>
                                <tr>
                                    <td width="4%" class="textb">&nbsp;</td>
                                    <td width="8%" class="textb" >&nbsp;</td>
                                    <td width="3%" class="textb">&nbsp;</td>
                                    <td width="7%" class="textb">&nbsp;</td>

                                    <td width="4%" class="textb">&nbsp;</td>
                                    <td width="8%" class="textb" >&nbsp;</td>
                                    <td width="3%" class="textb">&nbsp;</td>
                                    <td width="7%" class="textb">&nbsp;</td>

                                    <td width="4%" class="textb">&nbsp;</td>
                                    <td width="8%" class="textb" >&nbsp;</td>
                                    <td width="3%" class="textb">&nbsp;</td>
                                    <td width="12%" class="textb">&nbsp;</td>
                                </tr>
                                <tr>
                                    <td width="4%" class="textb">&nbsp;</td>
                                    <td width="8%" class="textb">DataSource</td>
                                    <td width="3%" class="textb"></td>
                                    <td width="7%" class="textb">
                                        <select size="1" name="archive" class="txtbox">
                                            <option value="true" <%=ESAPI.encoder().encodeForHTML(selectedArchived)%>>Archives</option>
                                            <option value="false" <%=ESAPI.encoder().encodeForHTML(selectedCurrent)%>>Current</option>
                                        </select>
                                    </td>

                                    <td width="4%" class="textb">&nbsp;</td>
                                    <td width="5%" class="textb" >Tracking Id</td>
                                    <td width="3%" class="textb">&nbsp;</td>
                                    <td width="7%" class="textb">
                                        <input type="text" maxlength="500" value="<%=ESAPI.encoder().encodeForHTMLAttribute(trackingid)%>"
                                               name="STrackingid" size="10" class="txtbox">
                                    </td>

                                    <td width="4%" class="textb">&nbsp;</td>
                                    <td width="4%" class="textb" >Name</td>
                                    <td width="3%" class="textb">&nbsp;</td>
                                    <td width="12%" class="textb">
                                        <input type=text name="name" maxlength="50"  value="<%=ESAPI.encoder().encodeForHTMLAttribute(name)%>" class="txtbox" size="10">
                                    </td>

                                </tr>
                                <tr>
                                    <td width="4%" class="textb">&nbsp;</td>
                                    <td width="8%" class="textb" >&nbsp;</td>
                                    <td width="3%" class="textb">&nbsp;</td>
                                    <td width="7%" class="textb">&nbsp;</td>

                                    <td width="4%" class="textb">&nbsp;</td>
                                    <td width="8%" class="textb" >&nbsp;</td>
                                    <td width="3%" class="textb">&nbsp;</td>
                                    <td width="7%" class="textb">&nbsp;</td>

                                    <td width="4%" class="textb">&nbsp;</td>
                                    <td width="8%" class="textb" >&nbsp;</td>
                                    <td width="3%" class="textb">&nbsp;</td>
                                    <td width="12%" class="textb">&nbsp;</td>

                                </tr>
                                <tr>
                                    <td width="4%" class="textb">&nbsp;</td>
                                    <td width="8%" class="textb" colspan="2">Card Number</td>
                                    <td width="7%" class="textb">
                                        <input type=text  name="firstfourofccnum" maxlength="6" size="5"  class="txtbox" style="width:60px" value="<%=firstfourofccnum%>">
                                        <input type=text name="lastfourofccnum" maxlength="4" size="4" class="txtbox" style="width:60px" value="<%=lastfourofccnum%>">
                                    </td>

                                    <td width="4%" class="textb">&nbsp;</td>
                                    <td width="5%" class="textb" >Amount</td>
                                    <td width="3%" class="textb">&nbsp;</td>
                                    <td width="7%" class="textb">
                                        <input type=text name="amount" maxlength="10"  value="<%=ESAPI.encoder().encodeForHTMLAttribute(amt)%>" class="txtbox" size="10">
                                    </td>
                                    <td width="4%" class="textb">&nbsp;</td>
                                    <td width="4%" class="textb" >Email Id</td>
                                    <td width="3%" class="textb">&nbsp;</td>
                                    <td width="12%" class="textb">
                                        <input type=text name="emailaddr" maxlength="50"  value="<%=ESAPI.encoder().encodeForHTMLAttribute(emailaddr)%>" class="txtbox" size="20">
                                    </td>

                                </tr>
                                <tr>
                                    <td width="4%" class="textb">&nbsp;</td>
                                    <td width="8%" class="textb" align="right"></td>
                                    <td width="3%" class="textb" align="center" ></td>
                                    <td width="7%" class="textb" align="left" style="font-size: 10px; color: #1D7F2C"><b>&nbsp;(Enter First six &nbsp;&&nbsp;  Last Four</b></td>

                                    <td width="4%" class="textb" style="font-size: 10px; color: #1D7F2C"><b>Credit Card No)</b></td>
                                    <td width="8%" class="textb" >&nbsp;</td>
                                    <td width="3%" class="textb">&nbsp;</td>
                                    <td width="7%" class="textb">&nbsp;</td>

                                    <td width="4%" class="textb">&nbsp;</td>
                                    <td width="8%" class="textb" >&nbsp;</td>
                                    <td width="3%" class="textb">&nbsp;</td>
                                    <td width="12%" class="textb">&nbsp;</td>
                                </tr>
                                <tr>
                                    <td width="4%" class="textb">&nbsp;</td>
                                    <td width="8%" class="textb" >&nbsp;</td>
                                    <td width="3%" class="textb">&nbsp;</td>
                                    <td width="7%" class="textb">&nbsp;</td>

                                    <td width="4%" class="textb">&nbsp;</td>
                                    <td width="8%" class="textb" >&nbsp;</td>
                                    <td width="3%" class="textb">&nbsp;</td>
                                    <td width="7%" class="textb">&nbsp;</td>

                                    <td width="4%" class="textb">&nbsp;</td>
                                    <td width="8%" class="textb" >&nbsp;</td>
                                    <td width="3%" class="textb">&nbsp;</td>
                                    <td width="12%" class="textb">&nbsp;</td>

                                </tr>
                                <tr>
                                    <td width="4%" class="textb">&nbsp;</td>
                                    <td width="8%" class="textb">Gateway</td>
                                    <td width="3%" class="textb"></td>
                                    <td width="12%" class="textb">
                                        <input name="pgtypeid" id="gateway1" value="<%=pgtypeid%>" class="txtbox" autocomplete="on">
                                    <%-- <select size="1" id="bank" name="pgtypeid" class="txtbox" style="width:200px;">
                                            <option value="0" default></option>
                                            <%
                                                for(String gatewayType : gatewayTypeTreeMap.keySet()){
                                                    String isSelected = "";
                                                    if (gatewayType.equalsIgnoreCase(pgtypeid))
                                                    {
                                                        isSelected = "selected";
                                                    }
                                            %>
                                            <option value="<%=gatewayType%>" <%=isSelected%>><%=gatewayType%>
                                            </option>
                                            <%
                                                }
                                            %>
                                        </select>--%>
                                    </td>
                                    <td width="4%" class="textb">&nbsp;</td>
                                    <td width="8%" class="textb">Account Id</td>
                                    <td width="3%" class="textb"></td>
                                    <td width="12%" class="textb">
                                        <input name="accountid" id="accountid1" value="<%=accountid%>" class="txtbox" autocomplete="on">
                                    </td>
                                    <td width="4%" class="textb">&nbsp;</td>
                                    <td width="8%" class="textb">Member Id</td>
                                    <td width="3%" class="textb"></td>
                                    <td width="12%" class="textb">
                                        <input name="toid" id="memberid1" value="<%=memberid%>" class="txtbox" autocomplete="on">
                                    </td>
                                </tr>
                                <tr>
                                    <td width="4%" class="textb">&nbsp;</td>
                                    <td width="8%" class="textb" >&nbsp;</td>
                                    <td width="3%" class="textb">&nbsp;</td>
                                    <td width="7%" class="textb">&nbsp;</td>

                                    <td width="4%" class="textb">&nbsp;</td>
                                    <td width="8%" class="textb" >&nbsp;</td>
                                    <td width="3%" class="textb">&nbsp;</td>
                                    <td width="7%" class="textb">&nbsp;</td>

                                    <td width="4%" class="textb">&nbsp;</td>
                                    <td width="8%" class="textb" >&nbsp;</td>
                                    <td width="3%" class="textb">&nbsp;</td>
                                    <td width="12%" class="textb">&nbsp;</td>
                                </tr>
                                <tr>
                                    <td width="4%" class="textb">&nbsp;</td>
                                    <td width="4%" class="textb">Remark</td>
                                    <td width="3%" class="textb" > </td>
                                    <td width="12%" class="textb">
                                        <input type=text name="remark" maxlength="50"  value="<%=ESAPI.encoder().encodeForHTMLAttribute(remark)%>" class="txtbox" size="50">
                                    </td>


                                    <td width="4%" class="textb">&nbsp;</td>
                                    <td width="8%" class="textb" >Description</td>
                                    <td width="3%" class="textb">&nbsp;</td>
                                    <td width="7%" class="textb">
                                        <input type=text name="desc" maxlength="50"  value="<%=ESAPI.encoder().encodeForHTMLAttribute(desc)%>" class="txtbox" size="10">
                                    </td>

                                    <td width="4%" class="textb">&nbsp;</td>
                                    <td width="5%" class="textb">Order Despription</td>
                                    <td width="3%" class="textb" > </td>
                                    <td width="7%" class="textb">
                                        <input type=text name="orderdesc" maxlength="50"  value="<%=ESAPI.encoder().encodeForHTMLAttribute(orderdesc)%>" class="txtbox" size="20">
                                    </td>
                                </tr>
                                <tr>
                                    <td width="4%" class="textb">&nbsp;</td>
                                    <td width="8%" class="textb" >&nbsp;</td>
                                    <td width="3%" class="textb">&nbsp;</td>
                                    <td width="7%" class="textb">&nbsp;</td>

                                    <td width="4%" class="textb">&nbsp;</td>
                                    <td width="8%" class="textb" >&nbsp;</td>
                                    <td width="3%" class="textb">&nbsp;</td>
                                    <td width="7%" class="textb">&nbsp;</td>

                                    <td width="4%" class="textb">&nbsp;</td>
                                    <td width="8%" class="textb" >&nbsp;</td>
                                    <td width="3%" class="textb">&nbsp;</td>
                                    <td width="12%" class="textb">&nbsp;</td>

                                </tr>

                                <tr>
                                    <td width="4%" class="textb">&nbsp;</td>
                                    <td width="4%" class="textb">Card Type</td>
                                    <td width="3%" class="textb" > </td>
                                    <td width="12%" class="textb">
                                        <input name="cardtype" id="ctype" value="<%=cardtype%>" class="txtbox" autocomplete="on">
                                    </td>


                                    <td width="4%" class="textb">&nbsp;</td>
                                    <td width="8%" class="textb" >Issuing Bank Name</td>
                                    <td width="3%" class="textb">&nbsp;</td>
                                    <td width="7%" class="textb">
                                        <input name="issuing_bank" id="ibank" value="<%=issuing_bank%>" class="txtbox" autocomplete="on">
                                    </td>

                                    <td width="4%" class="textb">&nbsp;</td>
                                    <td width="8%" class="textb" >Status Flag</td>
                                    <td width="3%" class="textb">&nbsp;</td>
                                    <td width="12%" class="textb">
                                        <select size="1" name="statusflag" class="txtbox">
                                            <option value="all">All</option>
                                            <%
                                                Set statusflagSet = statusFlagHash.keySet();
                                                iterator= statusflagSet.iterator();
                                                String selected3 = "";
                                                String key3 = "";
                                                String value3 = "";

                                                while(iterator.hasNext())
                                                {
                                                    key3=(String)iterator.next();
                                                    value3 = statusFlagHash.get(key3);

                                                    if (key3.equals(flaghash))
                                                        selected3 = "selected";
                                                    else
                                                        selected3 = "";

                                            %>
                                            <option value="<%=ESAPI.encoder().encodeForHTMLAttribute(key3)%>" <%=selected3%>><%=ESAPI.encoder().encodeForHTML(value3)%></option>
                                            <%
                                                }
                                            %>
                                        </select>
                                    </td>
                                </tr>

                                <tr>
                                    <td width="4%" class="textb">&nbsp;</td>
                                    <td width="8%" class="textb" >&nbsp;</td>
                                    <td width="3%" class="textb">&nbsp;</td>
                                    <td width="7%" class="textb">&nbsp;</td>

                                    <td width="4%" class="textb">&nbsp;</td>
                                    <td width="8%" class="textb" >&nbsp;</td>
                                    <td width="3%" class="textb">&nbsp;</td>
                                    <td width="7%" class="textb">&nbsp;</td>

                                    <td width="4%" class="textb">&nbsp;</td>
                                    <td width="8%" class="textb" >&nbsp;</td>
                                    <td width="3%" class="textb">&nbsp;</td>
                                    <td width="12%" class="textb">&nbsp;</td>

                                </tr>

                                <tr>
                                    <td width="4%" class="textb">&nbsp;</td>
                                    <td width="4%" class="textb">Payment ID</td>
                                    <td width="3%" class="textb" > </td>
                                    <td width="12%" class="textb">
                                        <input type=text name="paymentid" maxlength="50"  value="<%=ESAPI.encoder().encodeForHTMLAttribute(paymentid)%>" class="txtbox" size="50">
                                    </td>

                                    <td width="4%" class="textb">&nbsp;</td>
                                    <td width="8%" class="textb">Date Type</td>
                                    <td width="3%" class="textb">&nbsp;</td>
                                    <td width="12%" class="textb">
                                        <select size="1" name="datetype" class="txtbox">
                                            <%
                                                if("TIMESTAMP".equals(dateType))
                                                {%>
                                            <option value="DTSTAMP">DTSTAMP</option>
                                            <option value="TIMESTAMP" SELECTED>TIMESTAMP</option>
                                            <%}
                                            else
                                            {%>
                                            <option value="DTSTAMP" SELECTED>DTSTAMP</option>
                                            <option value="TIMESTAMP">TIMESTAMP</option>
                                            <%}
                                            %>
                                        </select>
                                    </td>

                                       <td width="4%" class="textb">&nbsp;</td>
                                       <td width="8%" class="textb" >&nbsp;</td>
                                       <td width="3%" class="textb">&nbsp;</td>
                                       <td width="12%" class="textb">&nbsp;</td>

                                </tr>
                                <tr>
                                    <td width="4%" class="textb">&nbsp;</td>
                                    <td width="8%" class="textb" >&nbsp;</td>
                                    <td width="3%" class="textb">&nbsp;</td>
                                    <td width="7%" class="textb">&nbsp;</td>
                                    <td width="4%" class="textb">&nbsp;</td>
                                    <td width="8%" class="textb" >&nbsp;</td>
                                    <td width="3%" class="textb">&nbsp;</td>
                                    <td width="7%" class="textb">&nbsp;</td>
                                    <td width="4%" class="textb">&nbsp;</td>
                                    <td width="10%" class="textb" >
                                        <input type="checkbox" value="yes" name="perfectmatch"><font color="#1D7F2C">&nbsp;&nbsp;<b>Show Perfect Match</b></font>
                                    </td>
                                    <td width="3%" class="textb">&nbsp;</td>
                                    <td width="12%" class="textb">
                                        <button type="submit" class="buttonform">
                                            Search
                                        </button>
                                    </td>
                                </tr>
                                <tr>
                                    <td width="4%" class="textb">&nbsp;</td>
                                    <td width="8%" class="textb" >&nbsp;</td>
                                    <td width="3%" class="textb">&nbsp;</td>
                                    <td width="7%" class="textb">&nbsp;</td>

                                    <td width="4%" class="textb">&nbsp;</td>
                                    <td width="8%" class="textb" >&nbsp;</td>
                                    <td width="3%" class="textb">&nbsp;</td>
                                    <td width="7%" class="textb">&nbsp;</td>

                                    <td width="4%" class="textb">&nbsp;</td>
                                    <td width="8%" class="textb" >&nbsp;</td>
                                    <td width="3%" class="textb">&nbsp;</td>
                                    <td width="12%" class="textb"></td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
</form>
<div class="reporttable">
    <%
        Hashtable hash = (Hashtable) request.getAttribute("transactionsdetails");
        Hashtable temphash = null;
        String error=(String ) request.getAttribute("errormessage");
        if(error !=null)
        {
            out.println("<b>");
            out.println(error);
            out.println("</b>");

        }
        if (hash != null && hash.size() > 0)
        {
            int records = 0;
            int totalrecords = 0;
            int currentblock = 1;

            try
            {
                records = Integer.parseInt((String) hash.get("records"));
                totalrecords = Integer.parseInt((String) hash.get("totalrecords"));
                if(request.getParameter("currentblock")!=null)
                {
                    currentblock = Integer.parseInt(request.getParameter("currentblock"));
                }
            }
            catch (NumberFormatException ex)
            {
                log.error("Records & TotalRecords is found null",ex);
            }
            str = str + "SRecords=" + pagerecords;
            str = str + "&ctoken=" + ctoken;
            String style = "class=td0";
            String ext = "light";
            if (records > 0)
            {

    %>
    <form name="exportform" method="post" action="ExportTransactions?ctoken=<%=ctoken%>" >
        <input type="hidden" value="<%=ESAPI.encoder().encodeForHTMLAttribute(desc)%>" name="desc">
        <input type="hidden" value="<%=ESAPI.encoder().encodeForHTMLAttribute(name)%>" name="name">
        <%
            if (!request.getParameter("toid").equalsIgnoreCase("0"))
            {
        %>
        <input type="hidden" value="<%=ESAPI.encoder().encodeForHTMLAttribute(toid)%>" name="toid">
        <%
            }
        %>
        <input type="hidden" value="<%=ESAPI.encoder().encodeForHTMLAttribute(amt)%>" name="amt">
        <input type="hidden" value="<%=ESAPI.encoder().encodeForHTMLAttribute(orderdesc)%>" name="orderdesc">
        <input type="hidden" value="<%=ESAPI.encoder().encodeForHTMLAttribute(emailaddr)%>" name="emailaddr">
        <input type="hidden" value="<%=ESAPI.encoder().encodeForHTMLAttribute(trackingid)%>" name="trackingid">
        <input type="hidden" value="<%=ESAPI.encoder().encodeForHTMLAttribute(firstfourofccnum)%>" name="firstfourofccnum">
        <input type="hidden" value="<%=ESAPI.encoder().encodeForHTMLAttribute(lastfourofccnum)%>" name="lastfourofccnum">
        <input type="hidden" value="<%=ESAPI.encoder().encodeForHTMLAttribute(status)%>" name="status">
        <input type="hidden" value="<%=ESAPI.encoder().encodeForHTMLAttribute(remark)%>" name="remark">
        <input type="hidden" value="<%=ESAPI.encoder().encodeForHTMLAttribute(fdate)%>" name="fdate">
        <input type="hidden" value="<%=ESAPI.encoder().encodeForHTMLAttribute(tdate)%>" name="tdate">
        <input type="hidden" value="<%=ESAPI.encoder().encodeForHTMLAttribute(fmonth)%>" name="fmonth">
        <input type="hidden" value="<%=ESAPI.encoder().encodeForHTMLAttribute(tmonth)%>" name="tmonth">
        <input type="hidden" value="<%=ESAPI.encoder().encodeForHTMLAttribute(fyear)%>" name="fyear">
        <input type="hidden" value="<%=ESAPI.encoder().encodeForHTMLAttribute(tyear)%>" name="tyear">
        <input type="hidden" value="<%=ESAPI.encoder().encodeForHTMLAttribute(refundamount)%>" name="refundamount">
        <input type="hidden" value="<%=archive%>" name="archive">
        <input type="hidden" value="<%=ESAPI.encoder().encodeForHTMLAttribute(startTime)%>" name="starttime">
        <input type="hidden" value="<%=ESAPI.encoder().encodeForHTMLAttribute(endTime)%>" name="endtime">
        <input type="hidden" value="<%=ESAPI.encoder().encodeForHTMLAttribute(dateType)%>" name="datetype">
        <input type="hidden" value="<%=ESAPI.encoder().encodeForHTMLAttribute(perfectmatch)%>" name="perfectmatch">
        <input type="hidden" value="<%=ESAPI.encoder().encodeForHTMLAttribute(pgtypeid)%>" name="pgtypeid">
        <input type="hidden" value="<%=ESAPI.encoder().encodeForHTMLAttribute(accountid)%>" name="accountid">
        <input type="hidden" value="<%=ESAPI.encoder().encodeForHTMLAttribute(cardtype)%>" name="cardtype">
        <input type="hidden" value="<%=ESAPI.encoder().encodeForHTMLAttribute(issuing_bank)%>" name="issuing_bank">
        <input type="hidden" value="<%=ESAPI.encoder().encodeForHTMLAttribute(paymentid)%>" name="paymentid">
        <%
            if (request.getParameter("pgtypeid")!=null)
            {
        %>
        <input type="hidden" value="<%=ESAPI.encoder().encodeForHTMLAttribute(request.getParameter("pgtypeid"))%>" name="gateway">
        <%

            }
//            if (!request.getParameter("accountid").equalsIgnoreCase("0"))
//            {
        %>
        <input type="hidden" value="<%=ESAPI.encoder().encodeForHTMLAttribute(request.getParameter("accountid"))%>" name="accountid">
        <%--<%
            }
        %>--%>
        <button type="submit" class="button3" style="width:15%;margin-left:85% ;margin-top:0px"><b>Export to excel</b>&nbsp;&nbsp;&nbsp;<img width="20%" height="100%" border="0" src="/merchant/images/excel.png"></button>
    </form>
    <br>
    <div id="containrecord"></div>
    <table border="1" cellpadding="5" cellspacing="0" width="750" align="center" class="table table-striped table-bordered table-hover table-green dataTable">
        <thead>
        <tr>
            <td width="7%" class="th0">Date</td>
            <td width="4%" class="th1">Tracking ID</td>
            <td width="4%" class="th1">Partner Name</td>
            <td width="7%" class="th0">Description</td>
            <td width="10%" class="th1">Order Description</td>
            <td width="7%" class="th0">Card Holder's Name</td>
            <td width="7%" class="th0">Brand</td>
            <td width="7%" class="th1">Amount</td>
            <td width="7%" class="th0">Refund Amount</td>
            <td width="7%" class="th0">Status</td>
            <td width="12%" class="th0">Remark</td>
        </tr>
        </thead>
        <%
            Functions functions=new Functions();
            for (int pos = 1; pos <= records; pos++)
            {
                String id = Integer.toString(pos);

                int srno = Integer.parseInt(id) + ((pageno - 1) * pagerecords);

                style = "class=\"tr" + pos % 2 + "\"";

                temphash = (Hashtable) hash.get(id);

                //String date = Functions.convertDtstampToDBFormat((String) temphash.get("dtstamp"));
                String date = (String) temphash.get("dtstamp");
                String description = (String) temphash.get("description");
                String orderdescription = (String) temphash.get("orderdescription");
                String icicitransid = (String) temphash.get("trackingid");
                String partnername = "";
                if (functions.isValueNull((String)temphash.get("totype")))
                {
                    partnername = (String)temphash.get("totype");
                }
                else
                {
                    partnername = "-";
                }
                String custname = (String) temphash.get("name");
                String bin_brand = "";
                if (functions.isValueNull((String) temphash.get("bin_brand")))
                {
                    bin_brand = (String) temphash.get("bin_brand");
                }
                else
                {
                    if(functions.isValueNull((String) temphash.get("cardtype")))
                    {
                        bin_brand=(String) temphash.get("cardtype");
                    }
                    else {
                        bin_brand = "-";
                    }
                }
                //String hrcode = (String) temphash.get("hrcode");
                String remark1 = (String) temphash.get("remark");
                refundamount = (String) temphash.get("refundamount");

                String currency = (String) temphash.get("currency");
                String accountId = (String) temphash.get("accountid");
                if(!functions.isValueNull(accountId))
                {
                    accountId = "";
                }
                if(!functions.isValueNull(remark1))
                {
                    remark1 = "-";
                }
                if(!functions.isValueNull(custname))
                {
                    custname = "-";
                }
                if(!functions.isValueNull(orderdescription))
                {
                    orderdescription = "-";
                }
                String amount = currency + " " + temphash.get("amount");
                refundamount = currency + " " + temphash.get("refundamount");
                String tempstatus = (String) statusHash.get(temphash.get("status"));
                out.println("<tr " + style + ">");
                out.println("<td align=center >" + date + "</td>");
                //out.println("<td align=center><form action=\"TransactionDetails?ctoken="+ctoken+"\" method=\"post\"><input type=\"hidden\" name=\"action\" value=\"TransactionDetails\"><input type=\"hidden\" name=\"STrackingid\" value=\""+icicitransid+"\"><input type=\"hidden\" name=\"ctoken\" value=\""+ctoken+"\"><input type=\"hidden\" name=\"archive\" value=\"false\"><input type=\"hidden\" name=\"accountid\" value=\""+accountId+"\"><input type=\"submit\" class=\"goto\" name=\"submit\" value=\""+icicitransid+"\"></form></td>");
                out.println("<td align=center>" +
                        "<form action=\"TransactionDetails?ctoken="+ctoken+"\" method=\"post\">" +
                        "<input type=\"hidden\" name=\"action\" value=\"TransactionDetails\">" +
                        "<input type=\"hidden\" name=\"STrackingid\" value=\""+icicitransid+"\">" +
                        "<input type=\"hidden\" name=\"partnername\" value=\""+partnername+"\">" +
                        "<input type=\"hidden\" name=\"ctoken\" value=\""+ctoken+"\">" +
                        "<input type=\"hidden\" name=\"archive\" value=\"false\">" +
                        "<input type=\"hidden\" name=\"accountid\" value=\""+accountId+"\">" +
                        "<input type=\"hidden\" name=\"fdate\" value=\""+fdate+"\">" +
                        "<input type=\"hidden\" name=\"tdate\" value=\""+tdate+"\">" +
                        "<input type=\"hidden\" name=\"fmonth\" value=\""+fmonth+"\">" +
                        "<input type=\"hidden\" name=\"tmonth\" value=\""+tmonth+"\">" +
                        "<input type=\"hidden\" name=\"fyear\" value=\""+fyear+"\">" +
                        "<input type=\"hidden\" name=\"tyear\" value=\""+tyear+"\">" +
                        "<input type=\"hidden\" name=\"starttime\" value=\""+startTime+"\">" +
                        "<input type=\"hidden\" name=\"endtime\" value=\""+endTime+"\">" +
                        "<input type=\"submit\" class=\"goto\" name=\"submit\" value=\""+icicitransid+"\">" +
                        "</form>" +
                        "</td>");
                out.println("<td align=center>" + ESAPI.encoder().encodeForHTML(partnername) + "</td>");
                out.println("<td align=center>" + ESAPI.encoder().encodeForHTML(description) + "</td>");
                out.println("<td align=center>" + ESAPI.encoder().encodeForHTML(orderdescription) + "</td>");
                out.println("<td align=center>" + ESAPI.encoder().encodeForHTML(custname) + "</td>");
                out.println("<td align=center>" + ESAPI.encoder().encodeForHTML(bin_brand) + "</td>");
                out.println("<td align=center>" + ESAPI.encoder().encodeForHTML(amount) + "</td>");
                out.println("<td align=center>" + ESAPI.encoder().encodeForHTML(refundamount) + "</td>");
                out.println("<td align=center>" + ESAPI.encoder().encodeForHTML(tempstatus) + "</td>");
                out.println("<td align=center>" + ESAPI.encoder().encodeForHTML(remark1) + "</td>");
                out.println("</tr>");
            }
        %>
        <thead>
        <tr>
            <td class="th0" align="center" class=textb>Page No:- <%=pageno%></td>
            <td class="th0"align="center" class=textb>Total Records: <%=totalrecords%></td>
            <td class="th0">&nbsp;</td>
            <td class="th0">&nbsp;</td>
            <td class="th0">&nbsp;</td>
            <td class="th0">&nbsp;</td>
            <td class="th0">&nbsp;</td>
            <td class="th0">&nbsp;</td>
            <td class="th0">&nbsp;</td>
            <td class="th0">&nbsp;</td>
            <td class="th0">&nbsp;</td>
        </tr>
        </thead>
    </table>
    <table align=center valign=top><tr>
        <td align=center>
            <jsp:include page="page.jsp" flush="true">
                <jsp:param name="numrecords" value="<%=totalrecords%>"/>
                <jsp:param name="numrows" value="<%=pagerecords%>"/>
                <jsp:param name="pageno" value="<%=pageno%>"/>
                <jsp:param name="str" value="<%=str%>"/>
                <jsp:param name="page" value="TransactionDetails"/>
                <jsp:param name="currentblock" value="<%=currentblock%>"/>
                <jsp:param name="orderby" value=""/>
            </jsp:include>
        </td>
    </table>
    <%
                }
                else
                {
                    out.println(Functions.NewShowConfirmation("Sorry", "No records found.<br><br>Date :<br>From " + fdate + "/" + (Integer.parseInt(fmonth) + 1) + "/" + fyear + "<br>To " + tdate + "/" + (Integer.parseInt(tmonth) + 1) + "/" + tyear));
                }
            }
            else
            {
                out.println(Functions.NewShowConfirmation("Sorry", "No records found"));
            }
        }
        catch (Exception e)
        {
            log.error("Exception while getting the transactions",e);
        }
    %>
</div>
<%
    }
    else
    {
        response.sendRedirect("/icici/logout.jsp");
        return;
    }
%>
</body>
</html>